<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Asistente San Joseito — POC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet"
  />
</head>
<body class="bg-light">
  <div class="container py-4">
    <h1 class="mb-4">Asistente San Joseito — POC</h1>

    <!-- Auth -->
    <div class="card mb-4" id="loginCard">
      <div class="card-body">
        <h5 class="card-title">1) Autenticación con Google</h5>
        <p class="mb-2">Primero inicia sesión para autorizar el acceso a tu Google Calendar.</p>

        <!-- Botón de login -->
        <a class="btn btn-primary" id="loginBtn" href="/auth/google">Iniciar sesión con Google</a>
        <small class="text-muted ms-2">Se abrirá en una pestaña nueva</small>

        <!-- Estado de sesión -->
        <div id="loginStatus" class="mt-3 small text-secondary">Verificando sesión...</div>
      </div>
    </div>

    <!-- Crear evento -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">2) Crear evento</h5>
        <form id="eventForm" class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Título</label>
            <input type="text" class="form-control" name="title" value="Demo POC" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Fecha (YYYY-MM-DD)</label>
            <input type="date" class="form-control" name="date" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Hora inicio (HH:mm)</label>
            <input type="time" class="form-control" name="startTime" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Hora fin (HH:mm)</label>
            <input type="time" class="form-control" name="endTime" required />
          </div>
          <div class="col-md-6">
            <label class="form-label">Zona horaria</label>
            <input type="text" class="form-control" name="timezone" value="America/Bogota" />
          </div>
          <div class="col-12">
            <button class="btn btn-success" type="submit">Crear evento</button>
          </div>
        </form>
        <pre id="createResult" class="mt-3 bg-body-tertiary p-3 border rounded" style="white-space:pre-wrap;"></pre>
      </div>
    </div>

    <!-- Listar eventos -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">3) Listar eventos</h5>
        <div class="row g-2 align-items-end">
          <div class="col-auto">
            <label class="form-label">Rango</label>
            <select id="range" class="form-select">
              <option value="today">today</option>
              <option value="tomorrow">tomorrow</option>
              <option value="next_days" selected>next_days</option>
            </select>
          </div>
          <div class="col-auto">
            <label class="form-label">Días (si next_days)</label>
            <input id="days" type="number" class="form-control" value="3" min="1" />
          </div>
          <div class="col-auto">
            <button id="listBtn" class="btn btn-primary">Listar</button>
          </div>
        </div>
        <pre id="listResult" class="mt-3 bg-body-tertiary p-3 border rounded" style="white-space:pre-wrap;"></pre>
      </div>
    </div>

    <!-- Chatbot -->
    <div class="card mb-4">
      <div class="card-body">
        <h5 class="card-title">4) Chatbot (Gemini)</h5>
        <p class="text-muted small">Escribe algo como: “crea un evento mañana a las 3pm llamado reunión de riesgos de 1 hora” o “qué tengo hoy”.</p>
        <div class="row g-2">
          <div class="col-12 col-md-9">
            <input id="chatInput" class="form-control" placeholder="Escribe tu petición..." />
          </div>
          <div class="col-12 col-md-3 d-grid">
            <button id="chatSend" class="btn btn-secondary">Enviar</button>
          </div>
        </div>
        <pre id="chatResult" class="mt-3 bg-body-tertiary p-3 border rounded" style="white-space:pre-wrap;"></pre>
      </div>
    </div>

    <footer class="text-muted">
      <small>POC: Calendar OK. Próximo paso: integrar Gemini + Google Keep.</small>
    </footer>
  </div>


  <script>
    // Crear evento
    document.getElementById('eventForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.target);
      const body = {
        title: fd.get('title'),
        date: fd.get('date'),
        startTime: fd.get('startTime'),
        endTime: fd.get('endTime'),
        timezone: fd.get('timezone') || 'America/Bogota'
      };
      try {
        const res = await fetch('/events', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        document.getElementById('createResult').textContent = JSON.stringify(data, null, 2);
      } catch (err) {
        document.getElementById('createResult').textContent = err.message;
      }
    });

    // Listar eventos
    document.getElementById('listBtn').addEventListener('click', async () => {
      const range = document.getElementById('range').value;
      const days = document.getElementById('days').value;
      const q = new URLSearchParams({ range, days }).toString();
      try {
        const res = await fetch('/events?' + q);
        const data = await res.json();
        document.getElementById('listResult').textContent = JSON.stringify(
          Array.isArray(data)
            ? data.map(ev => ({
                creator: ev.creator,
                summary: ev.summary,
                start: ev.start,
                end: ev.end,
                status: ev.status,
                htmlLink: ev.htmlLink
              }))
            : data,
          null,
          2
      );
            } catch (err) {
              document.getElementById('listResult').textContent = err.message;
            }
    });


     // consulta si hay sesión
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const res = await fetch('/auth/status');
        const { authenticated } = await res.json();

        const loginBtn = document.getElementById('loginBtn');
        const loginStatus = document.getElementById('loginStatus');

        if (authenticated) {
          loginBtn.style.display = 'none';
          loginStatus.textContent = 'Conectado con Google';
        } else {
          loginBtn.style.display = 'inline-block';
          loginStatus.textContent = 'No autenticado';
        }
        if (new URLSearchParams(location.search).get('auth') === 'ok') {
          history.replaceState({}, '', location.pathname);
        }
      } catch (e) {
        console.error(e);
      }
    });

    // Chatbot
    async function refreshEventsList() {
    try {
      const rangeSel = document.getElementById('range');
      const daysInput = document.getElementById('days');
      const range = rangeSel ? rangeSel.value : 'today';
      const days  = daysInput ? daysInput.value : 3;
      const res = await fetch('/events?' + new URLSearchParams({ range, days }));
      const data = await res.json();

      // Ajusta al mismo formato reducido que usas en listar
      const out = Array.isArray(data)
        ? data.map(ev => ({
            creator: ev.creator,
            summary: ev.summary,
            start: ev.start,
            end: ev.end,
            status: ev.status,
            htmlLink: ev.htmlLink
          }))
        : data;
      const target = document.getElementById('listResult');
      if (target) target.textContent = JSON.stringify(out, null, 2);
    } catch (e) {
      console.error(e);
    }
  }

  document.getElementById('chatSend').addEventListener('click', async () => {
    const input = document.getElementById('chatInput');
    const out   = document.getElementById('chatResult');
    const message = (input.value || "").trim();
    if (!message) return;

    out.textContent = "Procesando...";
    try {
      const res = await fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ message })
      });
      const data = await res.json();
      out.textContent = JSON.stringify(data, null, 2);

      // Si todo ok y fue create/list, refresca la lista de eventos
      if (data.ok && (data.intent === 'create_event' || data.intent === 'list_events')) {
        await refreshEventsList();
      }
    } catch (e) {
      out.textContent = e.message;
    }
  });

  // ENTER para enviar
  document.getElementById('chatInput').addEventListener('keydown', (e) => {
    if (e.key === 'Enter') document.getElementById('chatSend').click();
  });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
